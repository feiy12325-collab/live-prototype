<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>ç›´æ’­åˆ—è¡¨ â€” Live Prototype</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/styles.css">
  <script src="https://kit.fontawesome.com/a2d9b3a5f2.js" crossorigin="anonymous"></script>
</head>
<body>
  <header class="topbar">
    <div class="brand">ğŸ¥ <strong>Live Prototype</strong></div>
    <div class="room-info">
      <div class="title">ç›´æ’­åˆ—è¡¨</div>
      <div class="sub">æµè§ˆæ‰€æœ‰ç›´æ’­æˆ¿é—´</div>
    </div>
    <div class="actions">
      <div id="authArea" class="auth"></div>
      <button id="createRoomBtn" class="btn small">+ åˆ›å»ºæˆ¿é—´</button>
    </div>
  </header>

  <main class="container-full">
    <section class="list-section">
      <h2>ğŸ”´ æ­£åœ¨ç›´æ’­</h2>
      <div id="liveRooms" class="rooms-grid"></div>

      <h2 style="margin-top:40px">â­• ç¦»çº¿æˆ¿é—´</h2>
      <div id="offlineRooms" class="rooms-grid"></div>
    </section>
  </main>

  <footer class="footer">&copy; Live Prototype â€” æœ¬åœ°æ¼”ç¤ºç”¨</footer>

  <!-- Modal for create room -->
  <div id="createModal" style="display:none" class="modal">
    <div class="modal-content">
      <h3>åˆ›å»ºæ–°æˆ¿é—´</h3>
      <input id="newRoomId" placeholder="æˆ¿é—´ IDï¼ˆä¾‹å¦‚ï¼šmystreamï¼‰" />
      <input id="newRoomName" placeholder="æˆ¿é—´åç§°ï¼ˆä¾‹å¦‚ï¼šæˆ‘çš„ç›´æ’­ï¼‰" />
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="cancelBtn" class="btn outline" style="flex:1">å–æ¶ˆ</button>
        <button id="confirmBtn" class="btn" style="flex:1">åˆ›å»º</button>
      </div>
    </div>
  </div>

  <script>
    const liveRooms = document.getElementById('liveRooms');
    const offlineRooms = document.getElementById('offlineRooms');
    const createRoomBtn = document.getElementById('createRoomBtn');
    const createModal = document.getElementById('createModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const confirmBtn = document.getElementById('confirmBtn');
    const newRoomId = document.getElementById('newRoomId');
    const newRoomName = document.getElementById('newRoomName');

    async function loadRooms() {
      try {
        const res = await fetch('/api/rooms');
        const rooms = await res.json();
        liveRooms.innerHTML = '';
        offlineRooms.innerHTML = '';

        rooms.forEach(room => {
          const card = document.createElement('div');
          card.className = 'room-card';
          card.innerHTML = `
            <div class="room-thumb" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">
              <div class="status-badge ${room.status}">
                <span>${room.status === 'live' ? 'ğŸ”´ ç›´æ’­ä¸­' : 'â­• ç¦»çº¿'}</span>
              </div>
            </div>
            <div class="room-meta">
              <div class="room-name">${room.name}</div>
              <div class="room-viewers"><i class="fas fa-eye"></i> ${room.viewers} äºº</div>
            </div>
          `;
          card.style.cursor = 'pointer';
          card.onclick = () => { window.location.href = `/watch.html?room=${room.id}`; };

          if (room.status === 'live') liveRooms.appendChild(card);
          else offlineRooms.appendChild(card);
        });
      } catch (err) {
        console.error('Failed to load rooms', err);
      }
    }

    createRoomBtn.onclick = () => { createModal.style.display = 'flex'; };
    cancelBtn.onclick = () => { createModal.style.display = 'none'; };

    // auth helpers
    const authArea = document.getElementById('authArea');
    function updateAuthUI() {
      const token = localStorage.getItem('token');
      const username = localStorage.getItem('username');
      if (token && username) {
        authArea.innerHTML = `<span class="muted">${username}</span> <button id="logoutBtn" class="btn small outline">é€€å‡º</button>`;
        document.getElementById('logoutBtn').onclick = () => { localStorage.removeItem('token'); localStorage.removeItem('username'); updateAuthUI(); };
      } else {
        authArea.innerHTML = `<button id="loginBtn" class="btn small">ç™»å½•</button>`;
        document.getElementById('loginBtn').onclick = doLogin;
      }
    }

    async function doLogin() {
      const name = prompt('è¯·è¾“å…¥ç”¨æˆ·å (ç¤ºä¾‹: alice)');
      if (!name) return;
      try {
        const res = await fetch('/api/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: name }) });
        if (!res.ok) throw new Error('login failed');
        const j = await res.json();
        localStorage.setItem('token', j.token);
        localStorage.setItem('username', j.username);
        updateAuthUI();
      } catch (err) { alert('ç™»å½•å¤±è´¥'); console.error(err); }
    }

    updateAuthUI();

    confirmBtn.onclick = async () => {
      const id = newRoomId.value.trim();
      const name = newRoomName.value.trim();
      if (!id || !name) { alert('è¯·è¾“å…¥æˆ¿é—´ ID å’Œåç§°'); return; }

      const token = localStorage.getItem('token');
      if (!token) {
        if (!confirm('åˆ›å»ºæˆ¿é—´éœ€è¦ç™»å½•ï¼Œæ˜¯å¦ç°åœ¨ç™»å½•ï¼Ÿ')) return;
        await doLogin();
      }

      try {
        const res = await fetch('/api/rooms', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` },
          body: JSON.stringify({ id, name })
        });
        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt || 'create failed');
        }
        createModal.style.display = 'none';
        newRoomId.value = '';
        newRoomName.value = '';
        loadRooms();
        alert(`æˆ¿é—´ "${name}" åˆ›å»ºæˆåŠŸï¼`);
      } catch (err) {
        alert(`åˆ›å»ºå¤±è´¥: ${err.message}`);
      }
    };

    // auto refresh every 5s
    loadRooms();
    setInterval(loadRooms, 5000);
  </script>
</body>
</html>